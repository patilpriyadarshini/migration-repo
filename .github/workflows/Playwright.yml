name: Playwright Tests
on:
  push:
    branches: [ main ]
jobs:
  test:
    timeout-minutes: 60
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-node@v4
      with:
        node-version: lts/*
        cache: 'npm'
        cache-dependency-path: ./Phase2_frontend
    - name: Install dependencies    
      working-directory: ./Phase2_frontend
      run: npm ci
    - name: Install Playwright Browsers
      working-directory: ./Phase2_frontend
      run: npx playwright install --with-deps
    - name: Run Playwright tests
      working-directory: ./Phase2_frontend
      run: npx playwright test --reporter=html
    - uses: actions/upload-artifact@v4
      if: ${{ !cancelled() }}
      with:
        name: playwright-report
        path: ./Phase2_frontend/playwright-report/
        retention-days: 30
    - name: Deploy report to GitHub Pages
      uses: peaceiris/actions-gh-pages@v4
      if: ${{ !cancelled() }}
      with: 
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./Phase2_frontend/playwright-report
        destination_dir: reports/${{ github.run_number }}
        keep_files: true
    - name: Send report metadata to n8n
      if: ${{ !cancelled() }}
      run: |
        REPORT_DATA=$(jq -n \
          --arg timestamp "$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
          --arg commit "${{ github.sha }}" \
          --arg run_id "${{ github.run_id }}" \
          --arg run_number "${{ github.run_number }}" \
          --arg pages_url "https://patilpriyadarshini.github.io/migration-repo/reports/${{ github.run_number }}/index.html" \
          --arg repository "${{ github.repository }}" \
          '{
            timestamp: $timestamp,
            commit_sha: $commit,
            run_id: $run_id,
            run_number: $run_number,
            pages_url: $pages_url,
            repository: $repository,
            event_type: "playwright_report_published"
          }')
        
        curl -X POST \
          -H "Content-Type: application/json" \
          -d "$REPORT_DATA" \
          "${{ secrets.N8N_WEBHOOK_URL }}" || echo "Webhook notification failed, but continuing..."
